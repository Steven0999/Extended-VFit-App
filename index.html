<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>FitTrack Pro V10</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* ============================================================
           FitTrack Pro V10 — Integrated Styles
           ============================================================ */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f1f5f9;
            margin: 0;
            padding-bottom: 5rem;
        }

        button { cursor: pointer; transition: all 0.25s ease; border: none; outline: none; }
        button:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(0,0,0,0.08); }
        button:active { transform: translateY(0); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        button:disabled { opacity: 0.6; cursor: not-allowed; transform: none !important; box-shadow: none !important; }

        input, select, textarea {
            font-family: 'Inter', sans-serif;
            outline: none;
            border: 1px solid #e5e7eb;
            background-color: #f8fafc;
            padding: 0.75rem 1rem;
            border-radius: 1rem;
            font-weight: 700;
            transition: border-color 0.25s ease, box-shadow 0.25s ease;
        }
        input:focus, select:focus { border-color: #6366f1; box-shadow: 0 0 0 2px rgba(99,102,241,0.2); }

        .glass-card {
            backdrop-filter: blur(12px);
            background: rgba(255, 255, 255, 0.75);
            border: 1px solid rgba(226, 232, 240, 0.3);
            box-shadow: 0 8px 32px rgba(0,0,0,0.05);
            border-radius: 2.5rem;
            padding: 1.5rem;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        .glass-card:hover { transform: translateY(-3px); box-shadow: 0 12px 30px rgba(0,0,0,0.1); }

        .progress-ring-circle { transform: rotate(-90deg); transform-origin: 50% 50%; transition: stroke-dashoffset 0.35s; }
        .hidden { display: none !important; }

        /* Navigation */
        nav { z-index: 50; }
        .nav-item.active i { color: #6366f1 !important; transform: scale(1.1); }
        .nav-item.active span { color: #6366f1 !important; font-weight: 900; }
        .nav-bg { background-color: rgba(99,102,241,0.1); transition: background 0.2s; }

        /* Tabs */
        .tab-content { opacity: 0; transform: translateY(10px); transition: opacity 0.3s ease, transform 0.3s ease; display: none; }
        .tab-content.active { opacity: 1; transform: translateY(0); display: block; pointer-events: auto; }

        /* Photos & Lists */
        .photo-slot { border: 2px dashed #cbd5e1; border-radius: 1.5rem; height: 5rem; display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative; }
        .photo-slot img { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 0; left: 0; }
        
        #daily-log-list, #history-list, #custom-db-list, #exercise-list {
            max-height: 24rem; overflow-y: auto; scrollbar-width: thin;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        /* Badge Styling */
        .badge-locked { filter: grayscale(1) opacity(0.5); }
        .badge-unlocked { filter: grayscale(0) opacity(1); animation: bounce 0.5s ease; }
        @keyframes bounce { 0%, 100% { transform: scale(1); } 50% { transform: scale(1.2); } }

        /* Scanner Modal & General Modals */
        #scanner-overlay, #generic-modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85); z-index: 100; display: none;
            flex-direction: column; align-items: center; justify-content: center;
        }
        #reader { width: 300px; height: 300px; background: #000; border-radius: 20px; overflow: hidden; }

        .dropdown-list {
            position: absolute; width: 100%; background: white; border: 1px solid #e2e8f0;
            border-radius: 1rem; margin-top: 5px; z-index: 60; max-height: 150px; overflow-y: auto;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        @media (max-width: 640px) {
            #dashboard .grid, #metrics .grid { grid-template-columns: 1fr !important; }
        }
    </style>
</head>
<body class="pb-28 bg-slate-50 font-sans">

<!-- Generic Modal Overlay -->
<div id="generic-modal-overlay" class="p-4">
    <div class="glass-card w-full max-w-sm p-6 max-h-[90vh] overflow-y-auto relative">
        <button onclick="closeModal()" class="absolute top-4 right-4 text-slate-400"><i data-lucide="x"></i></button>
        <h3 id="modal-title" class="text-lg font-black text-slate-800 mb-4">Add Exercise</h3>
        <div id="modal-content" class="space-y-4">
            <!-- Content injected by JS -->
        </div>
        <div id="modal-footer" class="flex gap-2 mt-6">
            <button onclick="closeModal()" class="flex-1 bg-slate-100 text-slate-600 p-4 rounded-2xl font-bold">Cancel</button>
            <button id="modal-confirm-btn" class="flex-1 bg-indigo-600 text-white p-4 rounded-2xl font-bold">Save</button>
        </div>
    </div>
</div>

<!-- Scanner Overlay -->
<div id="scanner-overlay">
    <div class="glass-card w-[90%] max-w-sm p-4 text-center">
        <h3 class="font-black text-slate-800 mb-4">Scan Food Barcode</h3>
        <div id="reader" class="mx-auto mb-4"></div>
        <button onclick="stopScanner()" class="w-full bg-slate-900 text-white p-4 rounded-2xl font-bold">Cancel</button>
    </div>
</div>

<header class="bg-white/70 backdrop-blur-md border-b border-slate-100 px-6 py-5 sticky top-0 z-40 flex justify-between items-center">
    <div>
        <h1 class="text-xl font-extrabold tracking-tight text-orange-400">Vaughan<span class="text-slate-600">Fitness</span></h1>
        <div class="flex items-center gap-2 mt-1">
            <span class="w-2 h-2 rounded-full bg-emerald-500 animate-pulse"></span>
            <p id="status-date" class="text-[10px] text-slate-500 font-bold uppercase tracking-widest">Live View</p>
        </div>
    </div>
    <div class="flex items-center gap-2">
        <button onclick="openEducationQuiz()" class="flex flex-col items-center gap-1 group">
            <div class="w-10 h-10 flex items-center justify-center bg-indigo-50 rounded-2xl group-hover:bg-indigo-100 transition-colors">
                <i data-lucide="graduation-cap" class="w-5 h-5 text-indigo-600"></i>
            </div>
            <span class="text-[8px] font-black uppercase text-indigo-600 tracking-tighter">Learn</span>
        </button>

        <div id="streak-container" class="flex flex-col items-center gap-1">
            <div class="flex items-center gap-1 bg-orange-50 px-3 py-1.5 h-10 rounded-2xl border border-orange-100">
                <i data-lucide="flame" class="w-4 h-4 text-orange-500"></i>
                <span id="streak-count" class="text-xs font-black text-orange-600">0</span>
            </div>
            <span class="text-[8px] font-black uppercase text-orange-500 tracking-tighter">Streak</span>
        </div>

        <button onclick="switchTab('settings')" class="flex flex-col items-center gap-1 group">
            <div class="w-10 h-10 flex items-center justify-center bg-slate-50 rounded-2xl group-hover:bg-slate-100 transition-colors">
                <i data-lucide="settings" class="w-5 h-5 text-slate-600"></i>
            </div>
            <span class="text-[8px] font-black uppercase text-slate-500 tracking-tighter">Settings</span>
        </button>
    </div>
</header>

<main class="max-w-xl mx-auto p-4 space-y-6">

    <section id="dashboard" class="tab-content active space-y-6">
        <!-- Calorie Ring -->
        <div class="glass-card rounded-[2.5rem] p-8 flex flex-col items-center relative overflow-hidden">
            <div class="relative w-48 h-48 flex items-center justify-center">
                <svg class="w-full h-full">
                    <circle class="text-slate-100" stroke-width="12" stroke="currentColor" fill="transparent" r="85" cx="96" cy="96"/>
                    <circle id="calorie-progress" class="text-indigo-600 progress-ring-circle" stroke-width="12" stroke-dasharray="534" stroke-dashoffset="534" stroke-linecap="round" stroke="currentColor" fill="transparent" r="85" cx="96" cy="96"/>
                </svg>
                <div class="absolute text-center">
                    <div id="dash-calories" class="text-4xl font-black text-slate-900">0</div>
                    <div class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Kcal Eaten</div>
                </div>
            </div>
            <div class="grid grid-cols-3 w-full gap-4 mt-8 border-t border-slate-100 pt-6">
                <div class="text-center">
                    <div id="dash-protein" class="font-bold text-slate-900">0g</div>
                    <div class="text-[9px] font-black uppercase text-slate-400">Protein</div>
                </div>
                <div class="text-center border-x border-slate-100">
                    <div id="dash-carbs" class="font-bold text-slate-900">0g</div>
                    <div class="text-[9px] font-black uppercase text-slate-400">Carbs</div>
                </div>
                <div class="text-center">
                    <div id="dash-fat" class="font-bold text-slate-900">0g</div>
                    <div class="text-[9px] font-black uppercase text-slate-400">Fats</div>
                </div>
            </div>
        </div>

        <!-- Level Progress -->
        <div class="glass-card p-6">
            <div class="flex justify-between items-end mb-2">
                <div>
                    <p class="text-[10px] font-black uppercase text-slate-400">Level <span id="user-lvl-display">1</span></p>
                    <h4 id="user-tier-display" class="font-bold text-slate-800">Bronze Athlete</h4>
                </div>
                <p class="text-[10px] font-bold text-slate-500"><span id="user-xp-display">0</span> / 500 XP</p>
            </div>
            <div class="w-full h-2 bg-slate-100 rounded-full overflow-hidden">
                <div id="xp-progress-bar" class="h-full bg-indigo-500 transition-all duration-500" style="width: 0%"></div>
            </div>
        </div>

        <!-- Achievements -->
        <div class="glass-card p-6">
            <h3 class="text-sm font-black uppercase tracking-widest text-slate-800 mb-4 flex items-center gap-2">
                <i data-lucide="award" class="w-4 h-4 text-indigo-500"></i> Achievements
            </h3>
            <div id="badge-grid" class="grid grid-cols-4 gap-4"></div>
        </div>

        <div class="glass-card rounded-[2.5rem] p-6 flex items-center justify-between">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-blue-50 rounded-2xl flex items-center justify-center">
                    <i data-lucide="droplet" class="text-blue-500"></i>
                </div>
                <div>
                    <h4 class="font-bold text-slate-800">Hydration</h4>
                    <p id="water-count" class="text-xs text-slate-500">0 / 2.5 Liters</p>
                </div>
            </div>
            <div class="flex items-center gap-2">
                <button onclick="updateWater(-250)" class="w-10 h-10 rounded-xl bg-slate-50 text-slate-400 hover:text-red-500 font-bold">-</button>
                <button onclick="updateWater(250)" class="w-10 h-10 rounded-xl bg-blue-600 text-white font-bold">+</button>
            </div>
        </div>
    </section>

    <section id="training" class="tab-content space-y-6">
        <div class="flex bg-slate-100 p-1.5 rounded-2xl">
            <button onclick="setTrainingView('setup')" id="train-tab-setup" class="flex-1 py-3 text-[10px] font-black uppercase tracking-widest rounded-xl transition-all bg-white text-indigo-600 shadow-sm">Workout</button>
            <button onclick="setTrainingView('library')" id="train-tab-library" class="flex-1 py-3 text-[10px] font-black uppercase tracking-widest rounded-xl transition-all text-slate-400">Library</button>
        </div>

        <div id="workout-setup-view" class="space-y-4">
            <div id="workout-setup" class="space-y-4">
                <div class="glass-card p-6 rounded-[2.5rem] border border-slate-100 shadow-sm text-center">
                    <div class="flex bg-slate-100 p-1 rounded-2xl mb-6 mx-auto w-fit">
                        <button onclick="setWorkoutEnv('gym')" id="env-tab-gym" class="px-6 py-2 text-[10px] font-black uppercase tracking-widest rounded-xl transition-all bg-white text-indigo-600 shadow-sm">Gym</button>
                        <button onclick="setWorkoutEnv('home')" id="env-tab-home" class="px-6 py-2 text-[10px] font-black uppercase tracking-widest rounded-xl transition-all text-slate-400">Home</button>
                    </div>
                    <select id="workout-focus" class="w-full p-4 bg-slate-50 rounded-2xl border-none font-bold mb-6 appearance-none text-center">
                        <option value="Full Body">Full Body</option>
                        <option value="Push">Upper Body (Push)</option>
                        <option value="Pull">Upper Body (Pull)</option>
                        <option value="Legs">Lower Body (Legs)</option>
                    </select>
                    <div class="grid grid-cols-2 gap-3">
                        <button onclick="startManualWorkout()" class="p-4 bg-slate-900 text-white rounded-[1.5rem] font-bold text-sm flex flex-col items-center gap-2">
                            <i data-lucide="plus-circle"></i> <span>Manual</span>
                        </button>
                        <button onclick="generateAIWorkout()" class="p-4 bg-indigo-600 text-white rounded-[1.5rem] font-bold text-sm flex flex-col items-center gap-2">
                            <i data-lucide="sparkles"></i> <span>AI Suggest</span>
                        </button>
                    </div>
                </div>
            </div>

            <div id="workout-active" class="hidden glass-card rounded-[2.5rem] p-6 shadow-sm">
                <div class="flex justify-between items-center mb-6">
                    <h3 id="active-workout-title" class="text-xl font-black text-slate-900">Workout</h3>
                    <button onclick="cancelWorkout()" class="text-slate-400 hover:text-red-500"><i data-lucide="x-circle"></i></button>
                </div>
                <div id="exercise-list" class="space-y-6 mb-6"></div>
                <button onclick="addExerciseField()" class="w-full p-4 border-2 border-dashed border-slate-200 rounded-2xl text-slate-400 font-bold text-xs uppercase tracking-widest mb-4">+ Add Exercise</button>
                <button onclick="saveWorkout()" class="w-full bg-slate-900 text-white p-5 rounded-[1.5rem] font-bold shadow-lg">Finish & Log Session</button>
            </div>
        </div>

        <div id="workout-library-view" class="hidden space-y-4">
            <button onclick="openExerciseForm()" class="w-full bg-indigo-600 text-white p-5 rounded-[2.5rem] font-bold flex items-center justify-center gap-2">
                <i data-lucide="plus-circle"></i> <span>Define New Exercise</span>
            </button>
            <div class="glass-card p-4">
                <h4 class="text-[10px] font-black uppercase text-slate-400 mb-4">Exercise Database</h4>
                <div id="exercise-database-list" class="space-y-2"></div>
            </div>
        </div>
    </section>

    <section id="nutrition" class="tab-content space-y-6">
        <div class="flex bg-slate-100 p-1.5 rounded-2xl">
            <button onclick="setNutritionTab('log')" id="nut-tab-log" class="flex-1 py-3 text-[10px] font-black uppercase tracking-widest rounded-xl transition-all bg-white text-indigo-600 shadow-sm">Diary</button>
            <button onclick="setNutritionTab('database')" id="nut-tab-db" class="flex-1 py-3 text-[10px] font-black uppercase tracking-widest rounded-xl transition-all text-slate-400">Inventory</button>
        </div>

        <div id="nut-view-log" class="space-y-6">
            <div class="flex gap-2">
                <div class="relative flex-1">
                    <i data-lucide="search" class="absolute left-4 top-1/2 -translate-y-1/2 text-slate-400 w-4 h-4"></i>
                    <input id="food-search" placeholder="Search your database..." class="w-full pl-12 pr-4 py-4 bg-white rounded-2xl border border-slate-100 shadow-sm focus:ring-2 ring-indigo-100 outline-none" oninput="handleFoodSearch(this.value)">
                    <div id="food-results" class="hidden absolute left-0 right-0 top-full mt-2 bg-white border border-slate-100 rounded-2xl overflow-hidden z-50 shadow-2xl max-h-64 overflow-y-auto"></div>
                </div>
                <button onclick="startScanner()" class="w-14 h-14 bg-indigo-600 text-white rounded-2xl flex items-center justify-center shadow-lg">
                    <i data-lucide="scan-barcode"></i>
                </button>
            </div>
            <div id="daily-log-list" class="space-y-3"></div>
        </div>

        <div id="nut-view-db" class="hidden space-y-6">
            <div class="glass-card p-4 space-y-4">
                <h4 class="text-xs font-black uppercase text-slate-400">Add Custom Item</h4>
                <input id="new-food-name" placeholder="Food Name" class="w-full bg-slate-50 text-sm">
                <div class="grid grid-cols-2 gap-2">
                    <input id="new-food-cal" type="number" placeholder="Kcal" class="bg-slate-50 text-sm">
                    <input id="new-food-prot" type="number" placeholder="Protein (g)" class="bg-slate-50 text-sm">
                </div>
                <button onclick="addCustomFood()" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold text-sm">Save to Inventory</button>
            </div>
            <div id="custom-db-list" class="divide-y divide-slate-50 max-h-80 overflow-y-auto"></div>
        </div>
    </section>

    <section id="metrics" class="tab-content space-y-6">
        <div class="glass-card p-8 rounded-[3rem] space-y-8">
            <div>
                <span class="text-[10px] font-black uppercase text-slate-400 block mb-1">Body Weight (kg)</span>
                <input id="body-weight" type="number" step="0.1" placeholder="00.0" class="w-full bg-slate-50 p-4 rounded-xl font-bold text-slate-900 outline-none">
            </div>
            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label class="text-[9px] font-black uppercase text-slate-400">Shoulders (cm)</label>
                    <input id="m-shoulders" type="number" class="w-full bg-slate-50 p-4 rounded-xl font-bold text-slate-900 outline-none" placeholder="00">
                </div>
                <div>
                    <label class="text-[9px] font-black uppercase text-slate-400">Chest (cm)</label>
                    <input id="m-chest" type="number" class="w-full bg-slate-50 p-4 rounded-xl font-bold text-slate-900 outline-none" placeholder="00">
                </div>
            </div>
            <div class="grid grid-cols-3 gap-3">
                <div class="photo-slot" onclick="triggerPhoto('front')">
                    <input type="file" id="file-front" accept="image/*" class="hidden" onchange="handlePhoto(this,'front')">
                    <div id="prev-front" class="flex flex-col items-center">
                        <i data-lucide="camera" class="text-slate-300"></i>
                        <span class="text-[8px] font-black uppercase text-slate-400">Front</span>
                    </div>
                </div>
                <div class="photo-slot" onclick="triggerPhoto('side')">
                    <input type="file" id="file-side" accept="image/*" class="hidden" onchange="handlePhoto(this,'side')">
                    <div id="prev-side" class="flex flex-col items-center">
                        <i data-lucide="camera" class="text-slate-300"></i>
                        <span class="text-[8px] font-black uppercase text-slate-400">Side</span>
                    </div>
                </div>
                <div class="photo-slot" onclick="triggerPhoto('back')">
                    <input type="file" id="file-back" accept="image/*" class="hidden" onchange="handlePhoto(this,'back')">
                    <div id="prev-back" class="flex flex-col items-center">
                        <i data-lucide="camera" class="text-slate-300"></i>
                        <span class="text-[8px] font-black uppercase text-slate-400">Back</span>
                    </div>
                </div>
            </div>
            <button onclick="saveMetrics()" class="w-full bg-rose-500 text-white p-5 rounded-2xl font-black uppercase text-xs tracking-widest shadow-xl shadow-rose-100 mt-4 flex items-center justify-center gap-2">
                <i data-lucide="save"></i> <span>Log Check-in</span>
            </button>
        </div>
    </section>

    <section id="settings" class="tab-content space-y-6">
        <div class="glass-card p-6 rounded-[2.5rem] space-y-4">
            <h4 class="text-[11px] font-black uppercase text-slate-400 tracking-wider">Calorie Goal</h4>
            <input type="number" id="set-cal-goal" class="w-full bg-slate-50 p-4 rounded-xl font-bold text-indigo-600 outline-none" onchange="FitTrack.state.user.calorieGoal = Number(this.value); FitTrack.storage.save();">
        </div>
        <button onclick="resetData()" class="w-full p-5 text-red-500 font-bold uppercase text-[10px] tracking-widest bg-red-50 rounded-2xl mt-4 flex items-center justify-center gap-2">
            <i data-lucide="trash-2"></i> <span>Purge All Records</span>
        </button>
    </section>

    <section id="history" class="tab-content space-y-6">
        <div class="flex bg-slate-100 p-1.5 rounded-2xl">
            <button onclick="setHistoryTab('training')" id="hist-tab-train" class="flex-1 py-3 text-[10px] font-black uppercase rounded-xl transition-all bg-white text-indigo-600 shadow-sm">Training</button>
            <button onclick="setHistoryTab('nutrition')" id="hist-tab-nut" class="flex-1 py-3 text-[10px] font-black uppercase rounded-xl transition-all text-slate-400">Food</button>
            <button onclick="setHistoryTab('body')" id="hist-tab-body" class="flex-1 py-3 text-[10px] font-black uppercase rounded-xl transition-all text-slate-400">Body</button>
        </div>
        <div id="history-list" class="space-y-4"></div>
    </section>

</main>

<nav class="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-xl border-t border-slate-100 px-6 py-4 flex justify-between items-center z-50">
    <button onclick="switchTab('dashboard')" data-tab="dashboard" class="nav-item text-slate-300 flex flex-col items-center gap-1 active">
        <div class="w-12 h-8 rounded-full flex items-center justify-center nav-bg"><i data-lucide="layout-grid" class="w-5 h-5"></i></div>
        <span class="text-[8px] font-black uppercase tracking-tighter">Dash</span>
    </button>
    <button onclick="switchTab('training')" data-tab="training" class="nav-item text-slate-300 flex flex-col items-center gap-1">
        <div class="w-12 h-8 rounded-full flex items-center justify-center nav-bg"><i data-lucide="dumbbell" class="w-5 h-5"></i></div>
        <span class="text-[8px] font-black uppercase tracking-tighter">Train</span>
    </button>
    <button onclick="switchTab('nutrition')" data-tab="nutrition" class="nav-item text-slate-300 flex flex-col items-center gap-1">
        <div class="w-12 h-8 rounded-full flex items-center justify-center nav-bg"><i data-lucide="apple" class="w-5 h-5"></i></div>
        <span class="text-[8px] font-black uppercase tracking-tighter">Eat</span>
    </button>
    <button onclick="switchTab('history')" data-tab="history" class="nav-item text-slate-300 flex flex-col items-center gap-1">
        <div class="w-12 h-8 rounded-full flex items-center justify-center nav-bg"><i data-lucide="calendar" class="w-5 h-5"></i></div>
        <span class="text-[8px] font-black uppercase tracking-tighter">Logs</span>
    </button>
    <button onclick="switchTab('metrics')" data-tab="metrics" class="nav-item text-slate-300 flex flex-col items-center gap-1">
        <div class="w-12 h-8 rounded-full flex items-center justify-center nav-bg"><i data-lucide="scale" class="w-5 h-5"></i></div>
        <span class="text-[8px] font-black uppercase tracking-tighter">Body</span>
    </button>
</nav>

<script>
/* ============================================================
   FITTRACK PRO V10 — Integrated JavaScript
   ============================================================ */
"use strict";

window.FitTrack = {
    version: "10.3.0",
    state: {
        user: { 
            xp: 0, level: 1, tier: "Bronze Athlete", 
            streak: 0, lastActive: null, calorieGoal: 2000,
            quizProgress: {
                beginner: { "Nutrition Core": false, "Training Core": false, "Recovery Core": false, "Nutrition (Further)": false, "Training (Further)": false, "Recovery (Further)": false }
            }
        },
        ui: { activeTab: "dashboard", workoutEnv: "gym" },
        history: { training: [], nutrition: [], metrics: [] },
        foodDatabase: [
            { name: "Chicken Breast", calories: 165, protein: 31, carbs: 0, fat: 3.6 },
            { name: "White Rice (1 cup)", calories: 205, protein: 4, carbs: 45, fat: 0.4 },
            { name: "Protein Shake", calories: 120, protein: 24, carbs: 3, fat: 1.5 }
        ],
        availableBadges: [
            { id: "first_workout", icon: "activity", title: "Beginner", desc: "Log 1st workout", requirement: () => FitTrack.state.history.training.length >= 1 },
            { id: "streak_3", icon: "flame", title: "Consistency", desc: "3 Day Streak", requirement: () => FitTrack.state.user.streak >= 3 },
            { id: "protein_king", icon: "beef", title: "Protein King", desc: "Log 100g protein in a day", requirement: () => {
                const today = new Date().toDateString();
                const protein = FitTrack.state.history.nutrition
                    .filter(n => new Date(n.date).toDateString() === today)
                    .reduce((a,b) => a + b.protein, 0);
                return protein >= 100;
            }},
            { id: "level_5", icon: "zap", title: "Veteran", desc: "Reach Level 5", requirement: () => FitTrack.state.user.level >= 5 }
        ],
        unlockedBadges: [],
        customExerciseLibrary: [
            { name: "Bench Press", focus: ["Push"], equip: ["Barbell"] },
            { name: "Squats", focus: ["Legs"], equip: ["Barbell"] },
            { name: "Deadlifts", focus: ["Pull", "Legs"], equip: ["Barbell"] },
            { name: "Overhead Press", focus: ["Push"], equip: ["Barbell"] },
            { name: "Dumbbell Rows", focus: ["Pull"], equip: ["Dumbbell"] },
            { name: "Pull-ups", focus: ["Pull"], equip: ["Bodyweight"] },
            { name: "Push-ups", focus: ["Push"], equip: ["Bodyweight"] }
        ],
        quizzes: {
            beginner: {
                "Nutrition Core": [
                    { q: "What is a calorie?", options: ["A unit of energy", "A type of fat", "A vitamin"], correct: 0, explanation: "A calorie is a unit of energy derived from food that fuels biological processes.", reference: "FAO (2003) 'Food energy - methods of analysis and conversion factors', Food and Nutrition Paper 77." },
                    { q: "Which macronutrient contains 9 kcal per gram?", options: ["Protein", "Carbohydrate", "Fat"], correct: 2, explanation: "Fats are the most energy-dense macronutrient, providing more than double the energy of proteins or carbs.", reference: "Atwater, W.O. (1899) 'The Nutritive Value of Food', Farmer's Bulletin." },
                    { q: "What is the primary role of protein?", options: ["Quick energy", "Tissue repair and growth", "Insulation"], correct: 1, explanation: "Proteins provide amino acids necessary for the structural repair of muscles and organs.", reference: "Campbell, B. et al. (2007) 'International Society of Sports Nutrition position stand: protein and exercise', JISSN." },
                    { q: "Which carb is 'complex'?", options: ["Sugar", "Oats", "Honey"], correct: 1, explanation: "Oats contain long-chain polysaccharides that digest slowly, providing sustained energy.", reference: "Slavin, J. (2013) 'Whole grains and human health', Nutrition Research Reviews." },
                    { q: "Hydration is key for...", options: ["Only sweating", "Nutrient transport", "Making hair grow"], correct: 1, explanation: "Water is the primary medium for transporting nutrients and oxygen to cells.", reference: "Jequier, E. (2010) 'Water as an essential nutrient: the physiological basis of hydration', European Journal of Clinical Nutrition." },
                    { q: "What is BMR?", options: ["Basic Muscle Rate", "Basal Metabolic Rate", "Body Mass Ratio"], correct: 1, explanation: "BMR is the energy expended while at rest in a neutrally temperate environment.", reference: "Henry, C.J. (2005) 'Basal metabolic rate studies in humans: measurement and development of new equations', Public Health Nutrition." },
                    { q: "Fiber is important for...", options: ["Muscle building", "Digestive health", "Vision"], correct: 1, explanation: "Fiber assists in bowel regularity and microbiome health.", reference: "Anderson, J.W. et al. (2009) 'Health benefits of dietary fiber', Nutrition Reviews." },
                    { q: "A 'Caloric Deficit' leads to...", options: ["Weight gain", "Weight loss", "No change"], correct: 1, explanation: "Consuming fewer calories than burned forces the body to use stored energy (fat).", reference: "Strasser, B. (2007) 'Fat loss depends on energy deficit only', Obesity Reviews." },
                    { q: "Vitamin C is found in high amounts in...", options: ["Steak", "Oranges", "Bread"], correct: 1, explanation: "Citrus fruits are potent sources of ascorbic acid (Vitamin C).", reference: "Carr, A.C. (2017) 'Vitamin C and Immune Function', Nutrients." },
                    { q: "Trans fats are generally considered...", options: ["Healthy", "Unhealthy", "Essential"], correct: 1, explanation: "Artificial trans fats increase LDL cholesterol and inflammation.", reference: "Mozaffarian, D. (2006) 'Trans Fatty Acids and Cardiovascular Disease', NEJM." },
                    { q: "What is the Glycemic Index?", options: ["Weight of food", "How food affects blood sugar", "Price of food"], correct: 1, explanation: "GI ranks carbs based on how quickly they raise blood glucose levels.", reference: "Jenkins, D.J. (1981) 'Glycemic index of foods: a physiological basis for carbohydrate exchange', AJCN." },
                    { q: "Iron is essential for...", options: ["Bone strength", "Oxygen transport", "Skin elasticity"], correct: 1, explanation: "Iron is a key component of hemoglobin in red blood cells.", reference: "Abbaspour, N. (2014) 'Review on iron and its importance for human health', Journal of Research in Medical Sciences." }
                ],
                "Nutrition (Further)": [
                    { q: "Which vitamin is synthesized via sunlight?", options: ["Vitamin A", "Vitamin D", "Vitamin K"], correct: 1, explanation: "UVB rays trigger the synthesis of Vitamin D3 in the skin.", reference: "Holick, M.F. (2007) 'Vitamin D deficiency', NEJM." },
                    { q: "What is the 'Thermic Effect of Food'?", options: ["Heating food", "Energy used to digest food", "Body heat after exercise"], correct: 1, explanation: "TEF represents the energy cost of processing food for use and storage.", reference: "Westerterp, K.R. (2004) 'Diet induced thermogenesis', Nutrition & Metabolism." },
                    { q: "Omega-3 fatty acids are mostly found in...", options: ["Chicken", "Fatty fish", "Pasta"], correct: 1, explanation: "Fish like salmon are rich in EPA and DHA omega-3s.", reference: "Swanson, D. (2012) 'Omega-3 Fatty Acids EPA and DHA: Health Benefits Throughout Life', Advances in Nutrition." },
                    { q: "Magnesium helps with...", options: ["Muscle relaxation", "Teeth whitening", "Hair color"], correct: 0, explanation: "Magnesium is a cofactor in over 300 enzyme systems, including muscle and nerve function.", reference: "Gröber, U. (2015) 'Magnesium in Prevention and Therapy', Nutrients." },
                    { q: "What is Creatine?", options: ["A steroid", "An amino acid derivative", "A vitamin"], correct: 1, explanation: "Creatine helps regenerate ATP during high-intensity exercise.", reference: "Buford, T.W. (2007) 'ISSN position stand: creatine supplementation and exercise', JISSN." },
                    { q: "Antioxidants protect against...", options: ["Muscle growth", "Free radicals", "Hydration"], correct: 1, explanation: "Antioxidants neutralize reactive oxygen species that cause cellular damage.", reference: "Lobo, V. (2010) 'Free radicals, antioxidants and functional foods', Pharmacognosy Review." },
                    { q: "Which is a fat-soluble vitamin?", options: ["C", "B12", "A"], correct: 2, explanation: "Vitamins A, D, E, and K require dietary fat for absorption.", reference: "Albahrani, A.A. (2016) 'Fat-soluble vitamins: clinical aspects and current analytical approaches', Clinical Biochemist Reviews." },
                    { q: "Satiety refers to...", options: ["Hunger", "Fullness", "Taste"], correct: 1, explanation: "Satiety is the state of feeling satisfied and full after eating.", reference: "Blundell, J.E. (1991) 'Dietary fat and the control of energy intake', AJCN." },
                    { q: "The primary fuel for high-intensity sprinting is...", options: ["Fat", "Glycogen", "Protein"], correct: 1, explanation: "Anaerobic glycolysis uses stored glycogen for rapid ATP production.", reference: "Baker, J.S. (2010) 'Interaction among Skeletal Muscle Metabolic Energy Systems during Intense Exercise', Journal of Nutrition and Metabolism." },
                    { q: "Zinc is crucial for...", options: ["Digestion", "Testosterone and immunity", "Bone density"], correct: 1, explanation: "Zinc plays a major role in hormonal health and immune response.", reference: "Prasad, A.S. (2008) 'Zinc in Human Health: Effect of Zinc on Immune Cells', Molecular Medicine." },
                    { q: "Electrolytes include...", options: ["Sugar and Flour", "Sodium and Potassium", "Iron and Zinc"], correct: 1, explanation: "Electrolytes carry electrical charges necessary for muscle contraction.", reference: "Sawka, M.N. (2007) 'American College of Sports Medicine position stand: Exercise and fluid replacement', MSSE." },
                    { q: "Intermittent Fasting primarily affects...", options: ["Insulin sensitivity", "Muscle fiber type", "Maximum heart rate"], correct: 0, explanation: "Fasting windows can help regulate blood glucose and insulin levels.", reference: "Tinsley, G.M. (2015) 'Effects of intermittent fasting on body composition and clinical health markers', Nutrition Reviews." },
                    { q: "Leucine is unique because it...", options: ["Is a fat", "Triggers muscle protein synthesis", "Is a sugar"], correct: 1, explanation: "Leucine directly activates the mTOR pathway for muscle growth.", reference: "Norton, L.E. (2006) 'Leucine regulates translation initiation of protein synthesis in skeletal muscle', Journal of Nutrition." }
                ],
                "Training Core": [
                    { q: "What is Progressive Overload?", options: ["Overtraining", "Gradual increase in stress", "Doing the same reps"], correct: 1, explanation: "Continuous improvement requires increasing weight, frequency, or volume over time.", reference: "Kraemer, W.J. (2004) 'Fundamentals of resistance training', MSSE." },
                    { q: "Hypertrophy is...", options: ["Fat gain", "Muscle growth", "Heart rate"], correct: 1, explanation: "Hypertrophy is the enlargement of muscle fibers.", reference: "Schoenfeld, B.J. (2010) 'The mechanisms of muscle hypertrophy', JSCR." },
                    { q: "A 'Compound Exercise' involves...", options: ["One joint", "Multiple joints", "No joints"], correct: 1, explanation: "Exercises like squats use multiple joints and muscle groups simultaneously.", reference: "Gentil, P. (2015) 'A Review of the Acute Effects and Long-Term Adaptations of Single- and Multi-Joint Exercises', Sports Medicine." },
                    { q: "RPE stands for...", options: ["Rate of Perceived Exertion", "Rest Per Exercise", "Repeat Power Effort"], correct: 0, explanation: "RPE measures how hard an individual feels they are working.", reference: "Borg, G. (1998) 'Borg's Perceived Exertion and Pain Scales', Human Kinetics." },
                    { q: "What is the 'Eccentric' phase?", options: ["Lifting", "Lowering", "Holding"], correct: 1, explanation: "The eccentric phase is the controlled lengthening of the muscle under tension.", reference: "Douglas, J. (2017) 'Chronic Adaptations to Eccentric Training: A Systematic Review', Sports Medicine." },
                    { q: "Which is a 'Pull' exercise?", options: ["Pushup", "Row", "Shoulder Press"], correct: 1, explanation: "Rows involve pulling resistance toward the body.", reference: "Haff, G.G. (2015) 'Essentials of Strength Training and Conditioning', NSCA." },
                    { q: "Volume is calculated as...", options: ["Sets x Reps", "Weight x Reps", "Sets x Reps x Weight"], correct: 2, explanation: "Total volume load accounts for the total work done.", reference: "Schoenfeld, B.J. (2017) 'Resistance Training Volume Enhances Muscle Hypertrophy', MSSE." },
                    { q: "What is 'Rest Interval'?", options: ["Time between workouts", "Time between sets", "Sleep time"], correct: 1, explanation: "Rest intervals allow for ATP and phosphocreatine resynthesis.", reference: "De Salles, B.F. (2009) 'Rest interval between sets in strength training', Sports Medicine." },
                    { q: "Concentric means...", options: ["Shortening", "Lengthening", "Staying still"], correct: 0, explanation: "Concentric contraction happens when the muscle shortens while producing force.", reference: "Knudson, D. (2007) 'Fundamentals of Biomechanics', Springer." },
                    { q: "Isometrics involve...", options: ["Explosive movement", "No visible movement", "Slow lowering"], correct: 1, explanation: "Isometric exercises involve muscle tension without changing muscle length.", reference: "Oranchuk, D.J. (2019) 'Isometric training and long-term adaptations', Sports Medicine." },
                    { q: "What is 'Form'?", options: ["Clothing", "Technique", "A document"], correct: 1, explanation: "Technique/Form ensures safety and optimal muscle recruitment.", reference: "Everett, G. (2009) 'Olympic Weightlifting', Catalyst Athletics." },
                    { q: "Cardio improves...", options: ["Strength", "Aerobic capacity", "Flexibility"], correct: 1, explanation: "Cardiovascular training enhances the efficiency of the heart and lungs.", reference: "Patel, H. (2017) 'Aerobic vs anaerobic exercise training effects on the cardiovascular system', World Journal of Cardiology." }
                ],
                "Training (Further)": [
                    { q: "What are Type II muscle fibers?", options: ["Slow twitch", "Fast twitch", "Cardiac"], correct: 1, explanation: "Type II fibers are used for explosive, powerful movements.", reference: "Wilson, J.M. (2012) 'The effects of endurance, strength, and power training on muscle fiber type shifting', JSCR." },
                    { q: "The 'SAID' principle stands for...", options: ["Specific Adaptation to Imposed Demands", "Safety Always In Diet", "Strength And Intense Drills"], correct: 0, explanation: "The body adapts specifically to the type of stress placed upon it.", reference: "Sale, D. (1981) 'Specificity of strength training: a review', Canadian Journal of Applied Sport Sciences." },
                    { q: "What is 'Deloading'?", options: ["Quitting gym", "Planned reduction in volume/intensity", "Lifting max weight"], correct: 1, explanation: "Deloads allow systemic fatigue to dissipate while maintaining skill.", reference: "Pritchard, H.J. (2015) 'Tapering and Peaking for Maximum Strength', Strategic Strength." },
                    { q: "Muscle Protein Synthesis (MPS) is triggered by...", options: ["Fasting", "Resistance training and protein", "Sleeping only"], correct: 1, explanation: "The combination of mechanical tension and amino acids maximizes MPS.", reference: "Biolo, G. (1997) 'An abundant supply of amino acids enhances the metabolic effect of exercise on muscle protein', AJCP." },
                    { q: "What is 'Supercompensation'?", options: ["Overtraining", "The post-recovery increase in performance", "Buying supplements"], correct: 1, explanation: "After recovery from stress, the body adapts beyond its previous baseline.", reference: "Zatsiorsky, V.M. (2006) 'Science and Practice of Strength Training', Human Kinetics." },
                    { q: "EMG measures...", options: ["Heart rate", "Muscle electrical activity", "Bone density"], correct: 1, explanation: "Electromyography tracks how much a muscle is 'firing' during a movement.", reference: "De Luca, C.J. (1997) 'The Use of Surface Electromyography in Biomechanics', Journal of Applied Biomechanics." },
                    { q: "The Valsalva Maneuver helps...", options: ["Running", "Intra-abdominal pressure for lifting", "Flexibility"], correct: 1, explanation: "Holding breath against a closed airway stabilizes the spine during heavy lifts.", reference: "Hackett, D.A. (2013) 'The Valsalva maneuver during resistance training', Sports Medicine." },
                    { q: "What is 'Tempo' training?", options: ["Music speed", "Controlling the speed of reps", "Total time in gym"], correct: 1, explanation: "Controlling rep speed alters time under tension and metabolic stress.", reference: "Wilk, M. (2018) 'The influence of movement tempo on hypertrophy', Journal of Human Kinetics." },
                    { q: "Plyometrics focus on...", options: ["Static holding", "The stretch-shortening cycle", "Endurance"], correct: 1, explanation: "Plyometrics use explosive movements to improve power.", reference: "Davies, G. (2015) 'Current concepts of plyometric exercise', International Journal of Sports Physical Therapy." },
                    { q: "Antagonist muscles...", options: ["Work together", "Oppose the movement", "Do nothing"], correct: 1, explanation: "An antagonist muscle relaxes while the agonist (prime mover) contracts.", reference: "Tortora, G.J. (2014) 'Principles of Anatomy and Physiology', Wiley." },
                    { q: "What is 'Overreaching'?", options: ["A stretch", "Short-term excess training", "Winning"], correct: 1, explanation: "Functional overreaching is a temporary dip in performance before supercompensation.", reference: "Halson, S.L. (2004) 'Does overtraining exist? An analysis of overreaching and overtraining', Sports Medicine." },
                    { q: "Biomechanics is the study of...", options: ["Biology of plants", "Mechanical laws of movement", "Gym equipment"], correct: 1, explanation: "Biomechanics applies physics to biological systems to optimize movement.", reference: "McGinnis, P.M. (2013) 'Biomechanics of Sport and Exercise', Human Kinetics." },
                    { q: "What is an 'Accommodation'?", options: ["A hotel", "Plateauing due to lack of variation", "Lifting heavier"], correct: 1, explanation: "The Law of Accommodation states that the response to a constant stimulus decreases over time.", reference: "Siff, M. (2003) 'Supertraining', Supertraining Institute." }
                ],
                "Recovery Core": [
                    { q: "How much sleep is recommended for athletes?", options: ["4-5 hours", "7-9 hours", "12+ hours"], correct: 1, explanation: "Optimal sleep supports hormonal balance and tissue repair.", reference: "Bird, S.P. (2013) 'Sleep, recovery, and athletic performance', Strength & Conditioning Journal." },
                    { q: "DOMS stands for...", options: ["Direct Onset Muscle Soreness", "Delayed Onset Muscle Soreness", "Daily Onset Muscle Soreness"], correct: 1, explanation: "DOMS usually peaks 24-48 hours after unfamiliar eccentric exercise.", reference: "Cheung, K. (2003) 'Delayed onset muscle soreness : treatment strategies and performance factors', Sports Medicine." },
                    { q: "The primary purpose of a cool-down is...", options: ["Building muscle", "Gradual return to resting state", "Wasting time"], correct: 1, explanation: "Cool-downs help clear metabolic byproducts and prevent blood pooling.", reference: "Takahashi, J. (2002) 'Effect of low-intensity exercise on recovery', Journal of Sports Sciences." },
                    { q: "What is 'Passive Recovery'?", options: ["Walking", "Total rest/stillness", "Lifting light"], correct: 1, explanation: "Passive recovery involves no activity, allowing the CNS to rest.", reference: "Dupuy, O. (2018) 'An Evidence-Based Approach for Choosing Post-exercise Recovery Techniques', Frontiers in Physiology." },
                    { q: "What is the role of Cortisol?", options: ["Builds muscle", "Stress hormone that breaks down tissue", "Makes you sleep"], correct: 1, explanation: "Chronically high cortisol can inhibit recovery and muscle growth.", reference: "Hill, E.E. (2008) 'Exercise and circulating cortisol levels: the intensity threshold effect', Journal of Endocrinological Investigation." },
                    { q: "Hydration impacts recovery by...", options: ["Making you heavy", "Aiding nutrient delivery and waste removal", "Cooling the skin only"], correct: 1, explanation: "Fluid balance is critical for cellular metabolic processes post-exercise.", reference: "Casa, D.J. (2005) 'Influence of hydration on physiological function and performance', Applied Physiology." },
                    { q: "Active recovery should be...", options: ["High intensity", "Low intensity", "Max effort"], correct: 1, explanation: "Low-intensity movement increases blood flow without adding stress.", reference: "Monedero, J. (2000) 'Effect of recovery interventions on lactate removal', IJSM." },
                    { q: "Foam rolling is a form of...", options: ["Strength training", "Self-myofascial release", "Cardio"], correct: 1, explanation: "Rolling can help reduce perceived muscle soreness and improve range of motion.", reference: "Behm, D.G. (2013) 'Acute effects of self-myofascial release', JSCR." },
                    { q: "Protein before bed can...", options: ["Make you fat", "Support overnight muscle protein synthesis", "Prevent sleep"], correct: 1, explanation: "Casein protein provides a slow release of amino acids during sleep.", reference: "Res, P.T. (2012) 'Protein ingestion before sleep improves post-exercise overnight recovery', MSSE." },
                    { q: "What is 'Mental Fatigue'?", options: ["Muscle tiredness", "Cognitive exhaustion affecting performance", "Forgetting weights"], correct: 1, explanation: "Psychological stress can impair physical recovery and focus.", reference: "Marcora, S.M. (2009) 'Mental fatigue impairs physical performance in humans', Journal of Applied Physiology." },
                    { q: "Contrast baths involve...", options: ["Hot and cold water", "Salt and pepper", "Mud and clay"], correct: 0, explanation: "Alternating temperatures may stimulate blood flow and reduce swelling.", reference: "Higgins, T.R. (2017) 'Effects of contrast water therapy on recovery', JSCR." },
                    { q: "Inflammation post-exercise is...", options: ["Always bad", "A necessary signal for adaptation", "Only for old people"], correct: 1, explanation: "Acute inflammation triggers the signaling cascades for repair and growth.", reference: "Peake, J.M. (2017) 'The role of inflammation in skeletal muscle regeneration', Frontiers in Physiology." }
                ],
                "Recovery (Further)": [
                    { q: "What is HRV?", options: ["Heart Rate Volume", "Heart Rate Variability", "High Resistance Velocity"], correct: 1, explanation: "HRV measures the variation in time between heartbeats, reflecting autonomic nervous system status.", reference: "Plews, D.J. (2013) 'Training adaptation and heart rate variability in elite endurance athletes', Sports Medicine." },
                    { q: "Adaptogens are substances that...", options: ["Increase fat", "Help the body manage stress", "Build bone"], correct: 1, explanation: "Herbs like Ashwagandha can help modulate the stress response.", reference: "Panossian, A. (2010) 'Effects of Adaptogens on the Central Nervous System', Pharmaceuticals." },
                    { q: "Alcohol consumption post-exercise...", options: ["Speeds recovery", "Impairs muscle protein synthesis", "Has no effect"], correct: 1, explanation: "Alcohol interferes with the signaling pathways for muscle repair.", reference: "Parr, E.B. (2014) 'Alcohol ingestion impairs maximal post-exercise rates of myofibrillar protein synthesis', PLOS ONE." },
                    { q: "Parasympathetic nervous system is the...", options: ["Fight or flight", "Rest and digest", "Muscle mover"], correct: 1, explanation: "Recovery occurs primarily when the parasympathetic system is dominant.", reference: "McCorry, L.K. (2007) 'Physiology of the Autonomic Nervous System', AJPE." },
                    { q: "Cryotherapy (Cold) primarily works by...", options: ["Burning fat", "Vasoconstriction and reduced metabolic activity", "Making you stronger"], correct: 1, explanation: "Cold reduces blood flow and secondary tissue damage after trauma.", reference: "Bleakley, C.M. (2012) 'Whole-body cryotherapy: empirical evidence and theoretical perspectives', Open Access Journal of Sports Medicine." },
                    { q: "Compression garments help by...", options: ["Limiting growth", "Improving venous return and reducing oscillation", "Looking cool"], correct: 1, explanation: "Squeezing the limbs helps return blood to the heart and reduces muscle vibration.", reference: "Hill, J. (2014) 'Compression garments and recovery from exercise-induced muscle damage', BJSM." },
                    { q: "Which phase of sleep is most for physical repair?", options: ["REM", "Deep Sleep (N3)", "Light Sleep (N1)"], correct: 1, explanation: "Growth hormone is released in high pulses during Deep Sleep.", reference: "Dattilo, M. (2011) 'Sleep and muscle recovery', Medical Hypotheses." },
                    { q: "Oxidative stress is caused by...", options: ["Oxygen in water", "Reactive Oxygen Species (ROS)", "Heavy lifting only"], correct: 1, explanation: "High intensity leads to ROS production which requires antioxidant balance.", reference: "Powers, S.K. (2008) 'Reactive oxygen species and skeletal muscle', American Journal of Physiology." },
                    { q: "Static stretching is best done...", options: ["Before a workout", "After a workout", "Never"], correct: 1, explanation: "Post-workout stretching can help return muscles to resting length and relax the CNS.", reference: "Page, P. (2012) 'Current concepts in muscle stretching', IJSPT." },
                    { q: "Cherry juice may help recovery due to...", options: ["Sugar content", "Anthocyanins (Anti-inflammatory)", "Color"], correct: 1, explanation: "Tart cherries contain compounds that reduce pain and inflammation.", reference: "Connolly, D.A. (2006) 'Efficacy of a tart cherry juice blend in preventing muscle damage', BJSM." },
                    { q: "Central Fatigue refers to...", options: ["Muscle failure", "The brain reducing motor drive", "Stomach ache"], correct: 1, explanation: "The CNS reduces output to protect the body from damage.", reference: "Gandevia, S.C. (2001) 'Spinal and supraspinal factors in human muscle fatigue', Physiological Reviews." },
                    { q: "Joint health is supported by...", options: ["Collagen and Vitamin C", "Sugar and Salt", "Bread"], correct: 0, explanation: "Collagen provides structural support for cartilage and tendons.", reference: "Shaw, G. (2017) 'Vitamin C-enriched gelatin supplementation before intermittent activity augments collagen synthesis', AJCN." },
                    { q: "The 'Anabolic Window' theory states...", options: ["You must eat within 30 mins", "Nutrition timing is irrelevant", "Only fats matter"], correct: 0, explanation: "While exaggerated, immediate post-workout nutrients support recovery signals.", reference: "Aragon, A.A. (2013) 'Nutrient timing revisited', JISSN." }
                ]
            }
        }
    }
};

let html5QrCode = null;

// Storage Logic
FitTrack.storage = {
    key: "fittrack_v10_data",
    save() { localStorage.setItem(this.key, JSON.stringify(FitTrack.state)); },
    load() {
        const data = localStorage.getItem(this.key);
        if (data) {
            const saved = JSON.parse(data);
            FitTrack.state.user = { ...FitTrack.state.user, ...saved.user };
            FitTrack.state.history = { ...FitTrack.state.history, ...saved.history };
            if(saved.foodDatabase) FitTrack.state.foodDatabase = saved.foodDatabase;
            if(saved.customExerciseLibrary) FitTrack.state.customExerciseLibrary = saved.customExerciseLibrary;
        }
        this.checkStreak();
    },
    checkStreak() {
        const today = new Date().toDateString();
        const last = FitTrack.state.user.lastActive ? new Date(FitTrack.state.user.lastActive).toDateString() : null;
        if (last === today) return;
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        if (last === yesterday.toDateString()) {
            FitTrack.state.user.streak++;
            FitTrack.xp.add(20 * FitTrack.state.user.streak, "Streak Bonus!");
        } else {
            FitTrack.state.user.streak = 1;
        }
        FitTrack.state.user.lastActive = new Date().toISOString();
        this.save();
    }
};

// UI Logic
window.switchTab = function(tabId) {
    document.querySelectorAll(".tab-content").forEach(t => t.classList.remove("active"));
    document.getElementById(tabId)?.classList.add("active");
    document.querySelectorAll(".nav-item").forEach(n => {
        n.classList.toggle("active", n.getAttribute("data-tab") === tabId);
    });
    FitTrack.state.ui.activeTab = tabId;
    if (tabId === 'dashboard') updateGamificationUI();
    if (tabId === 'nutrition') renderInventory();
    if (tabId === 'training') renderExerciseLibrary();
    if (tabId === 'history') setHistoryTab('training');
    FitTrack.storage.save();
};

window.setNutritionTab = function(tab) {
    document.getElementById("nut-view-log").classList.toggle("hidden", tab !== 'log');
    document.getElementById("nut-view-db").classList.toggle("hidden", tab !== 'database');
    document.getElementById("nut-tab-log").classList.toggle("bg-white", tab === 'log');
    document.getElementById("nut-tab-db").classList.toggle("bg-white", tab === 'database');
    if(tab === 'database') renderInventory();
};

window.setTrainingView = function(view) {
    document.getElementById("workout-setup-view").classList.toggle("hidden", view !== 'setup');
    document.getElementById("workout-library-view").classList.toggle("hidden", view !== 'library');
    document.getElementById("train-tab-setup").classList.toggle("bg-white", view === 'setup');
    document.getElementById("train-tab-library").classList.toggle("bg-white", view === 'library');
    if(view === 'library') renderExerciseLibrary();
};

window.setWorkoutEnv = function(env) {
    FitTrack.state.ui.workoutEnv = env;
    document.getElementById('env-tab-gym').classList.toggle('bg-white', env === 'gym');
    document.getElementById('env-tab-home').classList.toggle('bg-white', env === 'home');
};

function isLevelComplete(lvl) {
    const prog = FitTrack.state.user.quizProgress[lvl];
    if (!prog) return false;
    return Object.values(prog).every(v => v === true);
}

// Quiz / Education Logic
window.openEducationQuiz = function() {
    const modal = document.getElementById('generic-modal-overlay');
    const content = document.getElementById('modal-content');
    const title = document.getElementById('modal-title');
    const confirmBtn = document.getElementById('modal-confirm-btn');

    title.innerText = "Fitness Academy";
    content.innerHTML = `
        <p class="text-[10px] font-black uppercase text-slate-400 mb-2">Complete all topics to advance</p>
        <div class="grid grid-cols-1 gap-3">
            <button onclick="startLevelSelection('beginner')" class="p-5 bg-indigo-50 text-indigo-600 rounded-3xl font-bold flex justify-between items-center">
                <div class="text-left">
                    <span class="block text-sm uppercase tracking-wider">Education Curriculum</span>
                    <span class="text-[9px] opacity-60">Complete 25 questions per subject</span>
                </div>
                ${isLevelComplete('beginner') ? '<i data-lucide="check-circle" class="w-5 h-5"></i>' : '<i data-lucide="play" class="w-4 h-4"></i>'}
            </button>
        </div>
    `;
    confirmBtn.classList.add('hidden');
    modal.style.display = "flex";
    lucide.replace();
};

window.startLevelSelection = function(level) {
    const content = document.getElementById('modal-content');
    const topics = Object.keys(FitTrack.state.quizzes[level] || {});
    
    content.innerHTML = `
        <button onclick="openEducationQuiz()" class="text-[10px] font-black text-indigo-600 mb-4 flex items-center gap-1 uppercase">
            <i data-lucide="arrow-left" class="w-3 h-3"></i> Back
        </button>
        <h4 class="font-black text-slate-800 text-lg mb-4">Subject Selection</h4>
        <div class="grid grid-cols-1 gap-2">
            ${topics.map(topic => {
                const isPassed = FitTrack.state.user.quizProgress[level][topic];
                return `
                <button onclick="startQuiz('${level}', '${topic}')" class="w-full text-left p-4 bg-slate-50 hover:bg-slate-100 rounded-2xl font-bold text-sm flex justify-between items-center">
                    <span>${topic}</span>
                    ${isPassed ? '<i data-lucide="check" class="w-4 h-4 text-emerald-500"></i>' : '<i data-lucide="chevron-right" class="w-4 h-4 text-slate-300"></i>'}
                </button>
                `;
            }).join('')}
        </div>
    `;
    lucide.replace();
};

window.startQuiz = function(level, topic) {
    const questions = FitTrack.state.quizzes[level][topic];
    const content = document.getElementById('modal-content');
    let currentIdx = 0;
    let userAnswers = new Array(questions.length).fill(null);

    const showQuestion = () => {
        const q = questions[currentIdx];
        const selected = userAnswers[currentIdx];
        
        content.innerHTML = `
            <div class="flex justify-between items-center mb-4">
                <p class="text-[10px] font-black uppercase text-slate-400">${topic}</p>
                <p class="text-[10px] font-black text-indigo-600">Q ${currentIdx+1}/${questions.length}</p>
            </div>
            <h4 class="font-bold text-slate-800 text-lg leading-tight mb-6">${q.q}</h4>
            <div id="quiz-options-container" class="space-y-3">
                ${q.options.map((opt, i) => `
                    <button onclick="recordAnswer(${i})" class="quiz-opt-btn w-full text-left p-5 ${selected === i ? 'bg-indigo-600 text-white' : 'bg-slate-50 hover:bg-white'} border border-transparent rounded-2xl font-bold text-sm transition-all">
                        ${opt}
                    </button>
                `).join('')}
            </div>
            
            <div class="grid grid-cols-2 gap-3 mt-8">
                <button onclick="quizNav(-1)" class="p-4 bg-slate-100 text-slate-600 rounded-2xl font-bold text-xs uppercase" ${currentIdx === 0 ? 'disabled' : ''}>Previous</button>
                <button onclick="quizNav(1)" class="p-4 bg-indigo-600 text-white rounded-2xl font-bold text-xs uppercase">${currentIdx === questions.length - 1 ? 'Finish' : 'Next'}</button>
            </div>

            <div class="w-full h-1 bg-slate-100 rounded-full mt-8 overflow-hidden">
                <div class="h-full bg-indigo-500 transition-all" style="width: ${((currentIdx + 1)/questions.length)*100}%"></div>
            </div>
        `;
    };

    window.recordAnswer = (idx) => {
        userAnswers[currentIdx] = idx;
        showQuestion();
    };

    window.quizNav = (dir) => {
        if (dir === 1 && currentIdx === questions.length - 1) {
            if(userAnswers.includes(null)) {
                alert("Please answer all questions before finishing.");
                return;
            }
            finishQuizReview(level, topic, questions, userAnswers);
        } else {
            currentIdx += dir;
            showQuestion();
        }
    };

    showQuestion();
};

function finishQuizReview(level, topic, questions, userAnswers) {
    const content = document.getElementById('modal-content');
    let correctCount = 0;
    
    questions.forEach((q, i) => {
        if(userAnswers[i] === q.correct) correctCount++;
    });

    const percentage = (correctCount / questions.length) * 100;
    const passed = percentage >= 80; // Requirement slightly adjusted for difficulty

    if (passed) FitTrack.state.user.quizProgress[level][topic] = true;
    FitTrack.storage.save();

    let bibliography = questions.map(q => q.reference).filter(r => r);

    content.innerHTML = `
        <div class="text-center py-6 border-b border-slate-100 mb-6">
            <h4 class="font-black text-slate-800 text-xl mb-1">${passed ? 'Subject Passed!' : 'Requires Review'}</h4>
            <p class="text-sm text-slate-500">Score: <b>${Math.round(percentage)}%</b> (${correctCount}/${questions.length})</p>
        </div>

        <div class="space-y-8">
            ${questions.map((q, i) => `
                <div class="p-4 rounded-3xl ${userAnswers[i] === q.correct ? 'bg-emerald-50/50' : 'bg-red-50/50'} border border-slate-100">
                    <p class="text-[9px] font-black uppercase text-slate-400 mb-2">Question ${i+1}</p>
                    <h5 class="font-bold text-slate-800 mb-4 text-sm">${q.q}</h5>
                    <div class="space-y-2 mb-4">
                        <div class="p-3 rounded-xl bg-white text-xs ${userAnswers[i] === q.correct ? 'text-emerald-600 border border-emerald-100' : 'text-red-500 border border-red-100'}">
                            <b>Your Answer:</b> ${q.options[userAnswers[i]]}
                        </div>
                        ${userAnswers[i] !== q.correct ? `
                            <div class="p-3 rounded-xl bg-white text-xs text-emerald-600 border border-emerald-100">
                                <b>Correct Answer:</b> ${q.options[q.correct]}
                            </div>
                        ` : ''}
                    </div>
                    <div class="bg-white/50 p-4 rounded-2xl">
                        <p class="text-[10px] font-black uppercase text-indigo-600 mb-1">Scientific Detail</p>
                        <p class="text-xs text-slate-600 leading-relaxed">${q.explanation}</p>
                        <p class="mt-3 text-[8px] text-slate-400 italic font-medium">Ref: ${q.reference}</p>
                    </div>
                </div>
            `).join('')}
        </div>

        <div class="mt-10 pt-6 border-t border-slate-100">
            <h6 class="text-[10px] font-black uppercase text-slate-400 mb-4">Bibliography (Harvard System)</h6>
            <ul class="space-y-2">
                ${[...new Set(bibliography)].map(ref => `<li class="text-[9px] text-slate-500 leading-tight">${ref}</li>`).join('')}
            </ul>
        </div>

        <div class="sticky bottom-0 bg-white/80 backdrop-blur-md pt-4 pb-2 mt-8">
            <button onclick="startLevelSelection('${level}')" class="w-full bg-slate-900 text-white py-4 rounded-2xl font-bold uppercase text-xs tracking-widest">Back to Menu</button>
        </div>
    `;
    lucide.replace();
}

// Training Logic & Presets
const workoutPresets = {
    gym: {
        "Full Body": [{name: "Bench Press", sets: 3, reps: 8}, {name: "Leg Press", sets: 3, reps: 10}, {name: "Lat Pulldowns", sets: 3, reps: 12}, {name: "Shoulder Press", sets: 3, reps: 10}],
        "Push": [{name: "Incline DB Press", sets: 4, reps: 10}, {name: "Cable Flyes", sets: 3, reps: 15}, {name: "Tricep Pushdowns", sets: 3, reps: 12}, {name: "Lateral Raises", sets: 4, reps: 15}],
        "Pull": [{name: "Deadlifts", sets: 3, reps: 5}, {name: "Bent Over Rows", sets: 4, reps: 10}, {name: "Bicep Curls", sets: 3, reps: 12}, {name: "Face Pulls", sets: 3, reps: 15}],
        "Legs": [{name: "Barbell Squats", sets: 4, reps: 8}, {name: "Leg Extensions", sets: 3, reps: 12}, {name: "Hamstring Curls", sets: 3, reps: 12}, {name: "Calf Raises", sets: 4, reps: 15}]
    },
    home: {
        "Full Body": [{name: "Pushups", sets: 3, reps: 15}, {name: "Bodyweight Squats", sets: 3, reps: 20}, {name: "Burpees", sets: 3, reps: 10}, {name: "Plank", sets: 3, reps: 45}],
        "Push": [{name: "Diamond Pushups", sets: 4, reps: 12}, {name: "Pike Pushups", sets: 3, reps: 10}, {name: "Chair Dips", sets: 3, reps: 12}],
        "Pull": [{name: "Doorway Rows", sets: 4, reps: 15}, {name: "Superman Lifts", sets: 3, reps: 12}, {name: "Reverse Snow Angels", sets: 3, reps: 15}],
        "Legs": [{name: "Lunges", sets: 3, reps: 12}, {name: "Glute Bridges", sets: 4, reps: 20}, {name: "Wall Sit", sets: 3, reps: 30}]
    }
};

FitTrack.training = {
    active: false,
    exercises: [],
    addExercise(preset = {}) {
        this.exercises.push({ name: preset.name || "", sets: preset.sets || 3, reps: preset.reps || 10, weight: preset.weight || 0 });
        this.render();
    },
    render() {
        const container = document.getElementById("exercise-list");
        container.innerHTML = this.exercises.map((ex, i) => `
            <div class="glass-card p-4 rounded-2xl space-y-3 border border-slate-100 relative">
                <div class="relative">
                    <input class="w-full bg-slate-50 p-3 rounded-xl font-bold" 
                           id="ex-input-${i}"
                           value="${ex.name}" 
                           onfocus="showExerciseDropdown(${i})"
                           oninput="filterExerciseDropdown(${i}, this.value)" 
                           placeholder="Exercise Name">
                    <div id="ex-dropdown-${i}" class="dropdown-list hidden"></div>
                </div>
                <div class="grid grid-cols-3 gap-2">
                    <input type="number" class="bg-slate-50 p-3 rounded-xl" value="${ex.sets}" oninput="FitTrack.training.exercises[${i}].sets=Number(this.value)" placeholder="Sets">
                    <input type="number" class="bg-slate-50 p-3 rounded-xl" value="${ex.reps}" oninput="FitTrack.training.exercises[${i}].reps=Number(this.value)" placeholder="Reps">
                    <input type="number" class="bg-slate-50 p-3 rounded-xl" value="${ex.weight}" oninput="FitTrack.training.exercises[${i}].weight=Number(this.value)" placeholder="Kg">
                </div>
            </div>
        `).join('');
    }
};

window.showExerciseDropdown = function(idx) {
    const dropdown = document.getElementById(`ex-dropdown-${idx}`);
    dropdown.classList.remove('hidden');
    filterExerciseDropdown(idx, "");
};

window.filterExerciseDropdown = function(idx, val) {
    const dropdown = document.getElementById(`ex-dropdown-${idx}`);
    const results = FitTrack.state.customExerciseLibrary.filter(ex => ex.name.toLowerCase().includes(val.toLowerCase()));
    dropdown.innerHTML = results.map(ex => `
        <div onclick="selectExercise(${idx}, '${ex.name}')" class="p-3 hover:bg-slate-50 cursor-pointer text-xs font-bold border-b border-slate-50">
            ${ex.name}
        </div>
    `).join('');
};

window.selectExercise = function(idx, name) {
    FitTrack.training.exercises[idx].name = name;
    document.getElementById(`ex-input-${idx}`).value = name;
    document.getElementById(`ex-dropdown-${idx}`).classList.add('hidden');
};

window.openExerciseForm = function() {
    const modal = document.getElementById('generic-modal-overlay');
    const content = document.getElementById('modal-content');
    const title = document.getElementById('modal-title');
    const confirmBtn = document.getElementById('modal-confirm-btn');

    confirmBtn.classList.remove('hidden');
    title.innerText = "New Exercise Profile";
    content.innerHTML = `
        <input id="lib-ex-name" placeholder="Exercise Name" class="w-full bg-slate-50">
        <div class="space-y-2">
            <p class="text-[9px] font-black uppercase text-slate-400">Focus Areas</p>
            <div class="grid grid-cols-2 gap-2">
                <label class="flex items-center gap-2 p-2 bg-slate-50 rounded-xl text-xs font-bold"><input type="checkbox" name="focus" value="Push"> Push</label>
                <label class="flex items-center gap-2 p-2 bg-slate-50 rounded-xl text-xs font-bold"><input type="checkbox" name="focus" value="Pull"> Pull</label>
            </div>
        </div>
    `;

    confirmBtn.onclick = () => {
        const name = document.getElementById('lib-ex-name').value;
        if (!name) return;
        const focus = Array.from(document.querySelectorAll('input[name="focus"]:checked')).map(c => c.value);
        FitTrack.state.customExerciseLibrary.push({ name, focus, equip: [] });
        FitTrack.storage.save();
        renderExerciseLibrary();
        closeModal();
    };

    modal.style.display = "flex";
};

function renderExerciseLibrary() {
    const list = document.getElementById('exercise-database-list');
    list.innerHTML = FitTrack.state.customExerciseLibrary.map((ex, i) => `
        <div class="flex justify-between items-center p-4 bg-white rounded-2xl border border-slate-50">
            <div>
                <p class="font-bold text-slate-800">${ex.name}</p>
                <p class="text-[8px] text-slate-400 font-black uppercase tracking-widest">${(ex.focus || []).join(' • ')}</p>
            </div>
            <button onclick="removeExerciseFromLibrary(${i})" class="text-red-400"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
        </div>
    `).join('');
    lucide.replace();
}

window.removeExerciseFromLibrary = function(index) {
    FitTrack.state.customExerciseLibrary.splice(index, 1);
    FitTrack.storage.save();
    renderExerciseLibrary();
};

window.closeModal = () => {
    document.getElementById('generic-modal-overlay').style.display = "none";
};

window.startManualWorkout = function() {
    FitTrack.training.active = true;
    FitTrack.training.exercises = [];
    document.getElementById("workout-setup").classList.add("hidden");
    document.getElementById("workout-active").classList.remove("hidden");
    FitTrack.training.addExercise();
};

window.generateAIWorkout = function() {
    startManualWorkout();
    const focus = document.getElementById("workout-focus").value;
    const env = FitTrack.state.ui.workoutEnv;
    const items = workoutPresets[env][focus] || workoutPresets[env]["Full Body"];
    FitTrack.training.exercises = [];
    items.forEach(ex => FitTrack.training.addExercise(ex));
};

window.saveWorkout = function() {
    FitTrack.state.history.training.push({ id: crypto.randomUUID(), date: new Date().toISOString(), exercises: [...FitTrack.training.exercises] });
    FitTrack.xp.add(50, "Workout Completed");
    cancelWorkout();
};

window.cancelWorkout = function() {
    document.getElementById("workout-active").classList.add("hidden");
    document.getElementById("workout-setup").classList.remove("hidden");
};

window.addExerciseField = () => FitTrack.training.addExercise();

// Nutrition Logic
window.startScanner = function() {
    document.getElementById("scanner-overlay").style.display = "flex";
    html5QrCode = new Html5Qrcode("reader");
    html5QrCode.start({ facingMode: "environment" }, { fps: 10, qrbox: { width: 250, height: 250 } }, onScanSuccess);
};

window.stopScanner = function() {
    if (html5QrCode) {
        html5QrCode.stop().then(() => { document.getElementById("scanner-overlay").style.display = "none"; });
    }
};

async function onScanSuccess(decodedText) {
    stopScanner();
    try {
        const res = await fetch(`https://world.openfoodfacts.org/api/v0/product/${decodedText}.json`);
        const data = await res.json();
        if (data.status === 1) {
            const p = data.product;
            const finalItem = {
                name: p.product_name || "Unknown Item",
                calories: Math.round(p.nutriments['energy-kcal_100g'] || 0),
                protein: p.nutriments.proteins_100g || 0,
                carbs: 0, fat: 0 
            };
            FitTrack.state.history.nutrition.push({id: crypto.randomUUID(), ...finalItem, date: new Date().toISOString()});
            FitTrack.xp.add(15, "Scanned Food");
            updateNutritionalDashboard();
        }
    } catch (e) { alert("Error connecting to API"); }
}

window.addCustomFood = function() {
    const name = document.getElementById("new-food-name").value;
    const cal = Number(document.getElementById("new-food-cal").value);
    const prot = Number(document.getElementById("new-food-prot").value);
    if (!name) return;
    FitTrack.state.foodDatabase.push({ name, calories: cal, protein: prot, carbs: 0, fat: 0 });
    document.getElementById("new-food-name").value = "";
    document.getElementById("new-food-cal").value = "";
    document.getElementById("new-food-prot").value = "";
    renderInventory();
    FitTrack.storage.save();
};

function renderInventory() {
    const list = document.getElementById("custom-db-list");
    list.innerHTML = FitTrack.state.foodDatabase.map(f => `
        <div class="p-4 flex justify-between items-center bg-white">
            <div>
                <div class="font-bold text-slate-800">${f.name}</div>
                <div class="text-[10px] text-slate-400 font-bold">${f.calories} kcal | ${f.protein}g Protein</div>
            </div>
            <button onclick="logFoodItem('${f.name}')" class="text-indigo-600 bg-indigo-50 px-3 py-1 rounded-lg text-[10px] font-black uppercase">Add</button>
        </div>
    `).join('');
}

window.handleFoodSearch = function(query) {
    const results = FitTrack.state.foodDatabase.filter(f => f.name.toLowerCase().includes(query.toLowerCase()));
    const box = document.getElementById("food-results");
    box.innerHTML = results.map(f => `<div onclick="logFoodItem('${f.name}')" class="p-4 hover:bg-slate-50 cursor-pointer text-sm font-bold border-b">${f.name} - ${f.calories}kcal</div>`).join('');
    box.classList.toggle("hidden", results.length === 0 || query === "");
};

window.logFoodItem = function(name) {
    const food = FitTrack.state.foodDatabase.find(f => f.name === name);
    FitTrack.state.history.nutrition.push({id: crypto.randomUUID(), ...food, date: new Date().toISOString()});
    FitTrack.xp.add(10, "Logged food");
    document.getElementById("food-results").classList.add("hidden");
    updateNutritionalDashboard();
};

function updateNutritionalDashboard() {
    const today = new Date().toDateString();
    const todayLogs = FitTrack.state.history.nutrition.filter(n => new Date(n.date).toDateString() === today);
    const totals = todayLogs.reduce((a, b) => ({
        calories: a.calories + b.calories,
        protein: a.protein + b.protein,
        carbs: a.carbs + b.carbs,
        fat: a.fat + b.fat
    }), {calories: 0, protein: 0, carbs: 0, fat: 0});

    document.getElementById("dash-calories").innerText = totals.calories;
    document.getElementById("dash-protein").innerText = Math.round(totals.protein) + "g";
    document.getElementById("dash-carbs").innerText = Math.round(totals.carbs) + "g";
    document.getElementById("dash-fat").innerText = Math.round(totals.fat) + "g";
    
    const ring = document.getElementById("calorie-progress");
    const goal = FitTrack.state.user.calorieGoal || 2000;
    ring.style.strokeDashoffset = 534 - (Math.min(totals.calories / goal, 1) * 534);
    FitTrack.storage.save();
}

// Metrics Logic
window.saveMetrics = function() {
    const weight = document.getElementById("body-weight").value;
    if (!weight) return;
    FitTrack.state.history.metrics.push({ id: crypto.randomUUID(), date: new Date().toISOString(), weight, shoulders: document.getElementById("m-shoulders").value, chest: document.getElementById("m-chest").value });
    FitTrack.xp.add(25, "Check-in");
    FitTrack.storage.save();
};

window.triggerPhoto = id => document.getElementById(`file-${id}`).click();
window.handlePhoto = (input, type) => {
    const reader = new FileReader();
    reader.onload = e => { document.getElementById(`prev-${type}`).innerHTML = `<img src="${e.target.result}" class="rounded-2xl w-full h-full object-cover">`; };
    reader.readAsDataURL(input.files[0]);
};

window.setHistoryTab = function(type) {
    document.getElementById("hist-tab-train").classList.toggle("bg-white", type === 'training');
    document.getElementById("hist-tab-nut").classList.toggle("bg-white", type === 'nutrition');
    document.getElementById("hist-tab-body").classList.toggle("bg-white", type === 'body');

    const list = document.getElementById("history-list");
    let data = type === 'training' ? FitTrack.state.history.training : type === 'nutrition' ? FitTrack.state.history.nutrition : FitTrack.state.history.metrics;

    list.innerHTML = data.slice().reverse().map(item => {
        const dateStr = new Date(item.date).toLocaleDateString();
        if (type === 'body') return `<div onclick="viewMetricDetails('${item.id}')" class="glass-card p-4 text-sm cursor-pointer"><div class="flex justify-between"><b>${dateStr}</b><span>${item.weight}kg</span></div></div>`;
        return `<div class="glass-card p-4 text-sm flex justify-between"><div><b>${dateStr}</b><p>${item.name || 'Session'}</p></div></div>`;
    }).join('');
    lucide.replace();
};

window.viewMetricDetails = function(id) {
    const metric = FitTrack.state.history.metrics.find(m => m.id === id);
    const modal = document.getElementById('generic-modal-overlay');
    const content = document.getElementById('modal-content');
    const title = document.getElementById('modal-title');
    const confirmBtn = document.getElementById('modal-confirm-btn');

    confirmBtn.classList.remove('hidden');
    title.innerText = `Update: ${new Date(metric.date).toLocaleDateString()}`;
    content.innerHTML = `
        <label class="text-[9px] font-black uppercase text-slate-400">Weight (kg)</label>
        <input id="edit-weight" type="number" step="0.1" value="${metric.weight}" class="w-full bg-slate-50 p-4">
        <button onclick="deleteMetric('${id}')" class="w-full bg-red-50 text-red-500 py-3 rounded-xl font-bold">Delete</button>
    `;

    confirmBtn.onclick = () => {
        metric.weight = document.getElementById('edit-weight').value;
        FitTrack.storage.save();
        setHistoryTab('body');
        closeModal();
    };
    modal.style.display = "flex";
};

window.deleteMetric = id => {
    FitTrack.state.history.metrics = FitTrack.state.history.metrics.filter(m => m.id !== id);
    FitTrack.storage.save();
    setHistoryTab('body');
    closeModal();
};

FitTrack.xp = {
    add(amt) {
        FitTrack.state.user.xp += amt;
        this.updateLevel();
        FitTrack.storage.save();
        updateGamificationUI();
    },
    updateLevel() {
        FitTrack.state.user.level = Math.floor(FitTrack.state.user.xp / 500) + 1;
        FitTrack.state.user.tier = FitTrack.state.user.level >= 10 ? "Diamond Pro" : FitTrack.state.user.level >= 5 ? "Silver Elite" : "Bronze Athlete";
    }
};

function updateGamificationUI() {
    const xpInLevel = FitTrack.state.user.xp % 500;
    document.getElementById('user-xp-display').innerText = xpInLevel;
    document.getElementById('user-lvl-display').innerText = FitTrack.state.user.level;
    document.getElementById('user-tier-display').innerText = FitTrack.state.user.tier;
    document.getElementById('xp-progress-bar').style.width = `${(xpInLevel / 500) * 100}%`;
    document.getElementById('streak-count').innerText = FitTrack.state.user.streak;

    const badgeGrid = document.getElementById('badge-grid');
    badgeGrid.innerHTML = FitTrack.state.availableBadges.map(badge => `
        <div class="flex flex-col items-center">
            <div class="w-12 h-12 rounded-full flex items-center justify-center ${FitTrack.state.unlockedBadges.includes(badge.id) ? 'bg-indigo-100' : 'bg-slate-100'}">
                <i data-lucide="${badge.icon}" class="w-6 h-6"></i>
            </div>
        </div>
    `).join('');
    lucide.replace();
}

window.updateWater = function(amt) {
    const countEl = document.getElementById("water-count");
    let current = (parseFloat(countEl.innerText) || 0) + (amt/1000);
    countEl.innerText = `${Math.max(0, current).toFixed(1)} / 2.5 Liters`;
};

window.resetData = () => { if(confirm("Erase all?")) { localStorage.clear(); location.reload(); } };

document.addEventListener("DOMContentLoaded", () => {
    FitTrack.storage.load();
    lucide.replace();
    switchTab('dashboard');
    updateNutritionalDashboard();
});
</script>
</body>
</html>

